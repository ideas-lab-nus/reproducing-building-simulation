---
title: "An example workflow of building energy model calibration"
author:
  - Hongyuan Jia
  - Adrian Chong
date: "`r Sys.Date()`"
output:
    html_document:
        toc: yes
        toc_float:
            collapsed: false
            smooth_scroll: false
        fig_caption: yes
        theme:
            version: 4
            bootswath: flatly
---

```{r setup, include = FALSE}
library(tidyverse, warn.conflicts = FALSE) # data analysis
library(lubridate, warn.conflicts = FALSE) # work with date time
library(eplusr)                            # integration with EnergyPlus
library(here)                              # project-root-based file path

# disable verbose information
eplusr_option(verbose_info = FALSE)

# install EnergyPlus v9.1 used in this workflow if necessary
if (!is_avail_eplus(9.1)) install_eplus(9.1, local = TRUE)

# load helper functions
source(here("R/functions.R"))
```

# Workflow

<!-- Create a workflow diagram? -->

- The model we choose with brief description

# Create synthetic meter data

- Read the original baseline model
- Define observed inputs, outputs and calibration parameters
- Run simulation to create synthetic data

## Read original baseline model

First, we read the baseline model using the `eplusr::read_idf()` function.

```{r read-ori}
# path of the baseline model
path_base <- here("data-raw/idf/Singapore_Concrete_Benchmark_Model.idf")

# read baseline model
base <- read_idf(path_base)
```

We remove all outputs in the baseline model. So

```{r}
# remove all existing outputs
base$`Output:Variable` <- NULL
base$`Output:Meter:MeterFileOnly` <- NULL
```

## Observed inputs, outputs and calibration parameters

We choose AMY (Annual Meteorological Year) as the observed input. According to
Fig.5 in our paper, AMY together with other separate local weather variables
are commonly used as the observed inputs for calibration.

For calibration parameters, we select 6 most commonly used ones from Fig. 6 of
our paper for demonstration, including:

- Material properties
- Infiltration rate
- Occupancy density
- Lighting power density
- Electric equipment power density
- Cooling setpoint

The mapping between those parameters and corresponding EnergyPlus inputs for
the baseline model are listed in the table blow:

| Calibration parameter            | Class                             | Object                                   | Field                                     | Value |
|----------------------------------+-----------------------------------+------------------------------------------+-------------------------------------------+-------|
| Material properties              | `Material`                        | `SGP_Concrete_200mm`                     | `Conductivity {W/m-K}`                    | 1.442 |
|                                  |                                   |                                          | `Density {kg/m3}`                         | 2400  |
|                                  |                                   |                                          | `Specific Heat {J/kg-K}`                  | 832   |
| Infiltration rate                | `ZoneInfiltration:DesignFlowRate` | All `*_Infiltration` objects for offices | `Air Changes per Hour {1/hr}`             | 0.2   |
| Occupancy density                | `People`                          | All objects for offices                  | `Zone Floor Area per Person {m2/persion}` | 10    |
| Lighting power density           | `Lights`                          | All `*_Lights` objects for offices       | `Watts per Zone Floor Area {W/m2}`        | 15    |
| Electric equipment power sensity | `ElectricEquipment`               | All `*_Equip` objects for offices        | `Watts per Zone Floor Area {W/m2}`        | 14    |
| Cooling setpoint                 | `Schedule:Compact`                | `Sch_Zone_Cooling_Setpoint_Wo_Solar`     | `Field 4`                                 | 24    |
|                                  |                                   | `Sch_Zone_Cooling_Setpoint_Solar`        | `Field 4`                                 | 23    |

For observed output, we choose hourly building electricity consumption. From
Fig. 7 in our paper, we can see that all calibration parameters we select
are commonly used together with building electricity consumption in
calibration studies we investigated. The corresponding output variable in
EnergyPlus is `Electriity: Building` with `Hourly` reporting frequency.

Next, we run the baseline model using AMY EPW file to create synthetic observed
output using simulations. The data will present noise-free measurements which
functions as a surrogate for clean sensor data.

Below we made some necessary to the baseline model, including adding the output
meter and setting the begin year of `RunPeriod` objects based on our AMY
weather data. We saved the modifed model as `AMY.idf` in the `data/idf` folder.

```{r add-outputs}
# add hourly building electricity output meter
base$add(Output_Meter = list("Electricity:Building", "Hourly"))

# update RunPeriod to correctly indicate an AMY EPW file is used
base$RunPeriod[[1]]$Name <- "Singapore 2018"
base$RunPeriod[[1]]$`Begin Year` <- 2018

# day of week for start day will be automatically calculated based on begin year
base$RunPeriod[[1]]$`Day of Week for Start Day` <- NULL

# save the model
base$save(here("data/idf/base.idf"), overwrite = TRUE)
```

## Run simulation to create synthetic data

Below we ran an annual simulation using the AMY EPW stored in
`data-raw/epw/AMY` folder.

```{r run-base}
# path of AMY EPW
path_epw_amy <- here("data-raw/epw/AMY/SGP_SINGAPORE-CHANGI-AP_486980_18.epw")

# run annual simulation for AMY
base$run(path_epw_amy, here("data/sim/base"), echo = FALSE)
```

Once the simulation completed, we extracted the output using `$report_data()`
method, convert the unit of electricity from Joules to kWh and save the values
together with the timestamp to a csv file named `synthetic_meter.csv` in the
`data` folder.

```{r meter-base}
meter_base <- base %>% extract_electricity()

# save synthetic meter data
write_csv(meter_base, here("data/synthetic_meter.csv"))
```

# Create the initial test model to be calibrated

In order to create a test model for calibration, we modified the values of 6
calibration parameters in the baseline model.

## Read the baseline model

```{r test}
# read the baseline model as the starting point for the test model
init <- read_idf(here("data/idf/base.idf"))
```

## Create the initial test model

```{r create-init}
update_material(init, conductivity = 0.8, density = 3800, specific_heat = 600)
update_infiltration(init, infil = 1)
update_people(init, people = 15)
update_lights(init, lpd = 12)
update_equip(init, epd = 10)
update_setpoint(init, core = 26, perimeter = 25)

# save
init$save(here("data/idf/init.idf"), overwrite = TRUE)
```

# Evaluate the performance of the initial init model

## Run initial simulation with IWEC

```{r sim-initial}
# read the initial test model
init <- read_idf(here("data/idf/init.idf"))
# get the file path of IWEC EPW file
path_epw_iwec <- here("data-raw/epw/IWEC/SGP_Singapore.486980_IWEC.epw")

# run annual simulation
init$run(path_epw_iwec, here("data/sim/init"), echo = FALSE)
```

## Extract the simulation results

```{r res-initial}
meter_init <- init %>% extract_electricity()
```

## Visualize the trend

```{r plot-init}
# select one week in July to examine the discrepancy
meter_init %>% weekly_compare(7, 1)
```

## Calculate the statistical indicators

```{r stats-init}
stats_init <- meter_init %>% cal_stats()
```

Current calibration creteria in ASHRAE Guideline 14 for NMBE and CVRMSE is 10%
and 30% respectively.

The initial CV(RMSE) is `r stats_init["cvrmse"]` and `r stats_init["nmbe"]`.

# Use AMY

```{r run-amy}
# read the initial test model
init <- read_idf(here("data/idf/init.idf"))
# path of AMY EPW
path_epw_amy <- here("data-raw/epw/AMY/SGP_SINGAPORE-CHANGI-AP_486980_18.epw")

# run annual simulation
init$run(path_epw_amy, here("data/sim/amy"), echo = FALSE)
```

```{r}
meter_amy <- init %>% extract_electricity()

meter_amy %>% weekly_compare(7, 1)

stats_amy <- meter_amy %>% cal_stats()
```

After using AMY EPW file, the CV(RMSE) is `r stats_amy["cvrmse"]` and `r stats_amy["nmbe"]`.

# Use optimization to calibrate the model

```{r}
# NOTE: have to combine all parameters in an unnamed list in order to directly
#       use the ecr::ecr() function. Otherwise, will have to construct the
#       workflow manually, which is what epluspar package does. But it will
#       require much more code. Using the ecr::ecr() may make it "simpler" to
#       non-programmers
calib_fitness <- function(params) {
    # read the initial model
    idf <- eplusr::read_idf(here::here("data/idf/init.idf"))

    # source the utility functions to avoid re-exporting them when evaluating
    # fitness in parallel using ecr which internally use parallelMap package
    source(here::here("R/functions.R"))

    conductivity  <- params[[1]]
    density       <- params[[2]]
    specific_heat <- params[[3]]
    infil         <- params[[4]]
    people        <- params[[5]]
    lpd           <- params[[6]]
    epd           <- params[[7]]
    core          <- params[[8]]
    perimeter     <- params[[9]]

    # update calibration parameter based on input
    update_material(idf, conductivity = conductivity, density = density,
        specific_heat = specific_heat)
    update_infiltration(idf, infil = infil)
    update_people(idf, people = people)
    update_lights(idf, lpd = lpd)
    update_equip(idf, epd = epd)
    update_setpoint(idf, core = core, perimeter = perimeter)

    # save
    idf$save(tempfile(fileext = ".idf"), overwrite = TRUE)

    # run simulation
    path_epw_amy <- here::here("data-raw/epw/AMY/SGP_SINGAPORE-CHANGI-AP_486980_18.epw")
    ## run simulation with AMY
    idf$run(path_epw_amy, echo = FALSE)

    # generate a plot
    p <- weekly_compare(idf, month = 7, week = 1)
    ## contruct individual plot path
    png_ind <- sprintf("%.png", tools::file_path_san_ext(idf$path()))
    ## save the plot
    ggplot2::ggsave(png_ind, p, height = 6, width = 10, dpi = 300)

    # calculate statistical indicators
    abs(cal_stats(idf))
}

# define the serach space of each parameter
space_param <- dplyr::tribble(
    ~parameter       , ~lower, ~upper,
     "conductivity"  ,    0.5,   2.0 ,
     "density"       ,   1000,  3000 ,
     "specific_heat" ,    600,  1000 ,
     "infil"         ,      0,    3  ,
     "people"        ,      5,   15  ,
     "lpd"           ,     10,   20  ,
     "epd"           ,     10,   20  ,
     "core"          ,     20,   26  ,
     "perimeter"     ,     20,   26
)

# create a terminator to stop simulation when CV(RMSE) and NMBE meet the
# creteria in ASHRAE Guideline 14
stopOnMeetCreteria <- function(cvrmse = 0.3, nmbe = 0.1) {
    condition.fun <- function(log) {
        # fitness of current individual
        fit <- log$env$pop[[log$env$n.evals]]$fitness
        # check if creteria are met
        fit[1] <= nmbe && fit[2] <= cvrmse
    }

    ecr::makeTerminator(
        condition.fun,
        name = "MeetCalibrationCreteria",
        message = sprintf("Calibration creteria (CVRMSE=%s, NMBE=%s) has been met", cvrmse, nmbe)
    )
}

# define setup values
MU <- 10L     # number of individuals per generation
LAMBDA <- 20L # number of generations

# run in parallel
# fix https://github.com/jakobbossek/ecr2/issues/130
parallelMap::parallelRegisterLevels(package = "ecr",
    levels = c("evaluateFitness", "generateOffspring", "computeDominanceRanking",
        "computeIndicators")
)

parallelMap::parallelStart(mode = "socket", cpus = 6)

results <- ecr::ecr(
    fitness.fun = calib_fitness,
    minimize = TRUE,
    n.objectives = 2,
    n.dim = nrow(space_param),
    lower = space_param$lower,
    upper = space_param$upper,
    representation = "float",
    mu = MU, lambda = LAMBDA,
    p.recomb = 0.7, p.mut = 0.3,
    log.pop = TRUE,
    terminators = list(stopOnMeetCreteria(cvrmse = 0.3, nmbe = 0.1))
)

parallelMap::parallelStop()
```


# Session Info

```{r}
sessionInfo()
```
